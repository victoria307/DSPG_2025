---
title: "Generate and Keep Relevant Variables (cl_02)"
subtitle: "Return to Education in U.S. 1940-2005"
author: "Henderson, Polachek, and Wang"
date: "2009-05-21"
format: html
execute:
  warning: false
  message: false
---

## Generate and keep relevant variables for analysis

```{r}
# Load required libraries
library(haven)
library(dplyr)
library(openxlsx)
```

## Replace the N/A values with missing values

```{r}
data_2000_i <- read.xlsx("data/outcome/2000_i.xlsx")

data_2000_i <- data_2000_i %>%
  mutate(incwage = ifelse(incwage >= 999999, NA, incwage))

write.xlsx(data_2000_i, "data/outcome/2000_i.xlsx")
```

## Generate a variable indicating whether or not the individual's wage is top-coded

```{r}
data_2000_i <- read.xlsx("data/outcome/2000_i.xlsx")

data_2000_i <- data_2000_i %>%
  mutate(topcoded = (incwage >= 175000 & incwage < 999999))

write.xlsx(data_2000_i, "data/outcome/2000_i.xlsx")
```

## Adjust the wage for inflation using the adjustment factors provided by IPUMS

```{r}
data_2000_i <- read.xlsx("data/outcome/2000_i.xlsx")

data_2000_i <- data_2000_i %>%
  mutate(incwage = incwage * 1)

write.xlsx(data_2000_i, "data/outcome/2000_i.xlsx")
```

## Recode the education variable and generate potential experience

```{r}
data_2000_i <- read.xlsx("data/outcome/2000_i.xlsx")

# Own education
data_2000_i <- data_2000_i %>%
  mutate(
    schooling = case_when(
      educd %in% c(0, 1, 2) ~ NA_real_,
      educd == 10 ~ 2.5,
      educd == 21 ~ 5.5,
      educd == 24 ~ 7.5,
      educd == 30 ~ 9,
      educd == 40 ~ 10,
      educd == 50 ~ 11,
      educd %in% c(61, 62) ~ 12,
      educd %in% c(65, 71) ~ 13,
      educd == 81 ~ 14,
      educd == 101 ~ 16,
      educd == 114 ~ 18,
      educd %in% c(115, 116) ~ 16,
      TRUE ~ educd
    ),
    
    # Own working experience
    exp = age - schooling - 6,
    exp = ifelse(exp < 0, 0, exp),
    exp2 = exp * exp,
    
    # Spousal Education
    schooling_sp = case_when(
      educd_sp %in% c(0, 1, 2) ~ NA_real_,
      educd_sp == 10 ~ 2.5,
      educd_sp == 21 ~ 5.5,
      educd_sp == 24 ~ 7.5,
      educd_sp == 30 ~ 9,
      educd_sp == 40 ~ 10,
      educd_sp == 50 ~ 11,
      educd_sp %in% c(61, 62) ~ 12,
      educd_sp %in% c(65, 71) ~ 13,
      educd_sp == 81 ~ 14,
      educd_sp == 101 ~ 16,
      educd_sp == 114 ~ 18,
      educd_sp %in% c(115, 116) ~ 16,
      TRUE ~ educd_sp
    )
  )

write.xlsx(data_2000_i, "data/outcome/2000_i.xlsx")
```

## Recode the weeks usually worked and generate weekly earnings

```{r}
data_2000_i <- read.xlsx("data/outcome/2000_i.xlsx")

data_2000_i <- data_2000_i %>%
  mutate(
    wkswork1 = ifelse(wkswork1 == 0, NA, wkswork1),
    weeks = wkswork1,
    wagewk = incwage / weeks
  )

write.xlsx(data_2000_i, "data/outcome/2000_i.xlsx")
```

## Generate hourly wage

```{r}
data_2000_i <- read.xlsx("data/outcome/2000_i.xlsx")

data_2000_i <- data_2000_i %>%
  mutate(
    uhrswork = ifelse(uhrswork == 0, NA, uhrswork),
    topcoded_uhr = (uhrswork == 99),
    wagehr = incwage / (weeks * uhrswork)
  )

write.xlsx(data_2000_i, "data/outcome/2000_i.xlsx")
```

## Generate Other Variables

```{r}
data_2000_i <- read.xlsx("data/outcome/2000_i.xlsx")
```

## Age Group

```{r}
data_2000_i <- data_2000_i %>%
  mutate(
    ageg = case_when(
      age >= 20 & age <= 29 ~ 1,
      age >= 30 & age <= 39 ~ 2,
      age >= 40 & age <= 49 ~ 3,
      age >= 50 & age <= 59 ~ 4,
      TRUE ~ NA_real_
    )
  )

# 1: 20-29
# 2: 30-39
# 3: 40-49
# 4: 50-59
```

## Marital Status

```{r}
data_2000_i <- data_2000_i %>%
  mutate(
    marr = case_when(
      marst == 1 ~ 1,
      marst > 1 & marst < 6 ~ NA_real_,
      marst > 6 | marst < 1 ~ NA_real_,
      TRUE ~ 0
    )
  )

# 1: Currently married
# 0: Not currently married (including cohabitating, 
#    but such cohabitating individuals will be included
#    in our analysis)
```

## Have a child under age 5

```{r}
data_2000_i <- data_2000_i %>%
  mutate(child5 = (nchlt5 > 0))
```

## Gender

```{r}
data_2000_i <- data_2000_i %>%
  mutate(male = (sex == 1))
```

## Region

```{r}
data_2000_i <- data_2000_i %>%
  mutate(
    region = case_when(
      region %in% c(11, 12, 13) ~ 1,
      region %in% c(21, 22, 23) ~ 2,
      region %in% c(31, 32, 33, 34) ~ 3,
      region %in% c(41, 42, 43) ~ 4,
      region %in% c(91, 92, 97, 99) ~ NA_real_,
      TRUE ~ region
    )
  )

# 1: Northeast 
# 2: Midwest 
# 3: South
# 4: West
```

## Race

```{r}
data_2000_i <- data_2000_i %>%
  mutate(
    race = case_when(
      race %in% c(4, 5, 6) ~ 4,
      race == 7 ~ 5,
      race %in% c(8, 9) ~ NA_real_,
      TRUE ~ race
    )
  )

# 1: White
# 2: Black/African American
# 3: American Indian or Alaska Native
# 4: Chinese
# 5: Japanese
```

## Immigrants

```{r}
data_2000_i <- data_2000_i %>%
  mutate(
    immigrant = case_when(
      bpl >= 100 & bpl <= 950 ~ 1,
      bpl > 950 ~ NA_real_,
      TRUE ~ 0
    )
  )

# 950: Other n.e.c(not elsewhere classified)
# > 950: Unknown/Missing
# >100 & < 950: US Outlying Areas/Territories
```

## Nativity

```{r}
# Drop observations for nativity coding
data_2000_i <- data_2000_i %>%
  filter(!(bpld >= 80000 & bpld <= 99900))

# Create 16 regions of countries of origin, follow Smith (2012)
data_2000_i <- data_2000_i %>%
  mutate(
    origin = case_when(
      # Canada, UK, Australia, New Zealand
      (bpld >= 15000 & bpld <= 19900) | (bpld >= 41000 & bpld <= 41410) | (bpld >= 70000 & bpld <= 70020) ~ 1,
      # Mexico
      bpld == 20000 ~ 2,
      # Central America
      bpld >= 21000 & bpld <= 21090 ~ 3,
      # Cuban
      bpld == 25000 ~ 4,
      # Other caribbean
      bpld >= 26000 & bpld <= 26095 ~ 5,
      # South America
      bpld >= 29999 & bpld <= 30091 ~ 6,
      # Northern/Northwestern Europe
      (bpld >= 40000 & bpld <= 40500) | (bpld >= 41900 & bpld <= 42900) | (bpld >= 45300 & bpld <= 45340) ~ 7,
      # Southern Europe
      bpld >= 43000 & bpld <= 44000 ~ 8,
      # Central Europe/Russian
      (bpld >= 45000 & bpld <= 45213) | (bpld >= 45400 & bpld <= 46590) ~ 9,
      # China
      bpld >= 50000 & bpld <= 50040 ~ 10,
      # Japan/Korea/Singapore
      bpld == 50100 | (bpld >= 50200 & bpld <= 50220) | bpld == 51600 ~ 11,
      # Other Southeast Asia
      bpld >= 50900 & bpld <= 51910 ~ 12,
      # India, Central Asia
      bpld >= 52000 & bpld <= 52150 ~ 13,
      # Middle East, North Africa
      (bpld >= 52200 & bpld <= 53300) | (bpld >= 53500 & bpld <= 54700) | (bpld >= 60010 & bpld <= 60019) ~ 14,
      # Other Africa
      bpld >= 60020 & bpld <= 60099 ~ 15,
      # Other
      TRUE ~ 16
    )
  )

# Total number of Groups:
# 1: Canada, UK, Australia, New Zealand
# 2: Mexico
# 3: Central America
# 4: Cuban
# 5: Other caribbean
# 6: South America
# 7: Northern/Northwestern Europe
# 8: Southern Europe
# 9: Central Europe/Russian
# 10: China
# 11: Japan/Korea/Singapore
# 12: Other Southeast Asia
# 13: India, Central Asia
# 14: Middle East, North Africa
# 15: Other Africa
# 16: home country grouping
```

## School currently in school

```{r}
data_2000_i <- data_2000_i %>%
  mutate(
    school = case_when(
      school %in% c(0, 9) ~ NA_real_,
      school == 1 ~ 0,
      school == 2 ~ 1,
      TRUE ~ school
    )
  )

# 0: Not in School
# 1: In School
```

## Self-employment

```{r}
data_2000_i <- data_2000_i %>%
  mutate(
    selfemp = case_when(
      classwkr == 0 ~ NA_real_,
      classwkr == 1 ~ 1,
      TRUE ~ 0
    )
  )

# 1: Self-employed
```

## Employment status of spouse

```{r}
data_2000_i <- data_2000_i %>%
  mutate(empst_sp = (empstatd_sp %in% c(10, 14)))

# 1: the spouse is currently at work 
# 0: the spouse is NA/not working/
#    not in labor force/ unemployed
```

## Keep the relevant variables

```{r}
indvar <- c("schooling", "schooling_sp", "exp", "exp2", "topcoded")
depvar <- c("incwage", "wagewk", "wagehr")
othervar <- c("year", "sample", "serial", "pernum", "gq", "statefip", "age", "ageg",
              "marr", "child5", "male", "region", "empstatd", "race", "immigrant", 
              "school", "selfemp", "topcoded_uhr", "origin", "empst_sp")
pweight <- c("perwt")

all_vars <- c(depvar, indvar, othervar, pweight)

data_2000_i <- data_2000_i %>%
  select(all_of(all_vars))

write_xlsx(data_2000_i, "data/outcome/2000_pre.xlsx")
```
